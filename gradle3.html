<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="微信公众号：大脑好饿"><title>使用 Gradle 实现一套代码开发多个应用 | 大脑好饿</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-71377766-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用 Gradle 实现一套代码开发多个应用</h1><a id="logo" href="/.">大脑好饿</a><p class="description">补充大脑营养</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用 Gradle 实现一套代码开发多个应用</h1><div class="post-meta">2017-07-11<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a href="/gradle3.html#SOHUCS" class="ds-thread-count"><span id="changyan_count_unit" style="font-size: 15px; color: #6E7173;">0</span><span> 条评论</span></a><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js" async></script><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#场景介绍"><span class="toc-number">1.</span> <span class="toc-text">场景介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#具体实现"><span class="toc-number">2.</span> <span class="toc-text">具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置多应用"><span class="toc-number">2.1.</span> <span class="toc-text">配置多应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置不同的包名"><span class="toc-number">2.2.</span> <span class="toc-text">配置不同的包名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态配置-URL-和版本号"><span class="toc-number">2.3.</span> <span class="toc-text">动态配置 URL 和版本号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置应用名"><span class="toc-number">2.4.</span> <span class="toc-text">配置应用名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置应用签名"><span class="toc-number">2.5.</span> <span class="toc-text">配置应用签名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置不同应用的代码和资源"><span class="toc-number">2.6.</span> <span class="toc-text">配置不同应用的代码和资源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#相关阅读"><span class="toc-number">4.</span> <span class="toc-text">相关阅读</span></a></li></ol></div></div><div class="post-content"><p>在文章 <a href="http://www.imliujun.com/gradle1.html">使用 Gradle 对应用进行个性化定制</a> 中，我们能够针对一个应用的正式服、测试服、超管服等其他版本，进行个性化定制。<br>这一篇文章我们来点大动作，让你用一套代码构建多个应用。</p>
<h1 id="场景介绍"><a href="#场景介绍" class="headerlink" title="场景介绍"></a>场景介绍</h1><p>需求：“将某个应用换一套皮肤、第三方账号、后台服务器，改个名字上线，并且以后的新功能同步进行更新”。</p>
<p>当你遇到这样的需求会怎么做呢？</p>
<p>是将项目复制一份，然后修改其中的内容，有新功能的时候再手动复制过来稍微修改一下 UI？</p>
<p>或者可以切换一个分支，在这个分支上修改相关的信息，每次开发完新功能，将代码合并过来，再稍微修改新功能的 UI？</p>
<p>现在我来介绍使用 <code>Gradle</code> 的 <code>flavorDimensions</code>，实现一份代码构建多个应用。</p>
<h1 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h1><p>老规矩，先上完整的 <code>Gradle</code> 配置：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">25</span></div><div class="line">    buildToolsVersion <span class="string">"25.0.3"</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">16</span></div><div class="line">        targetSdkVersion <span class="number">25</span></div><div class="line">        versionCode gitVersionCode()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 配置两个应用的签名文件</span></div><div class="line">    signingConfigs &#123;</div><div class="line">        app1 &#123;</div><div class="line">            storeFile <span class="keyword">file</span>(<span class="string">"app1.jks"</span>)</div><div class="line">            storePassword <span class="string">"111111"</span></div><div class="line">            keyAlias <span class="string">"app1"</span></div><div class="line">            keyPassword <span class="string">"111111"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        app2 &#123;</div><div class="line">            storeFile <span class="keyword">file</span>(<span class="string">"app2.jks"</span>)</div><div class="line">            storePassword <span class="string">"111111"</span></div><div class="line">            keyAlias <span class="string">"app2"</span></div><div class="line">            keyPassword <span class="string">"111111"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="comment">// 不显示Log</span></div><div class="line">            buildConfigField <span class="string">"boolean"</span>, <span class="string">"LOG_DEBUG"</span>, <span class="string">"false"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        debug &#123;</div><div class="line">            <span class="comment">// 显示Log</span></div><div class="line">            buildConfigField <span class="string">"boolean"</span>, <span class="string">"LOG_DEBUG"</span>, <span class="string">"true"</span></div><div class="line">            versionNameSuffix <span class="string">"-debug"</span></div><div class="line">            signingConfig <span class="keyword">null</span></div><div class="line">            manifestPlaceholders.UMENG_CHANNEL_VALUE = <span class="string">"test"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//创建两个维度的 flavor</span></div><div class="line">    flavorDimensions <span class="string">"APP"</span>, <span class="string">"SERVER"</span></div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line"></div><div class="line">        app1 &#123;</div><div class="line">            dimension <span class="string">"APP"</span></div><div class="line">            applicationId <span class="string">'com.imliujun.app1'</span></div><div class="line"></div><div class="line">            versionName rootProject.ext.APP1_versionName</div><div class="line"></div><div class="line">            <span class="comment">//应用名</span></div><div class="line">            resValue <span class="string">"string"</span>, <span class="string">"app_name"</span>, <span class="string">"APP1"</span></div><div class="line"></div><div class="line">            buildConfigField(<span class="string">"String"</span>, <span class="string">"versionNumber"</span>, <span class="string">"\"$&#123;rootProject.ext.APP1_versionName&#125;\""</span>)</div><div class="line"></div><div class="line">            <span class="comment">//第三方SDK的一些配置</span></div><div class="line">            buildConfigField <span class="string">"int"</span>, <span class="string">"IM_APPID"</span>, <span class="string">"app1的腾讯IM APPID"</span></div><div class="line">            buildConfigField <span class="string">"String"</span>, <span class="string">"IM_ACCOUNTTYPE"</span>, <span class="string">"\"app1的腾讯IM accountype\""</span></div><div class="line">            manifestPlaceholders = [UMENG_APP_KEY      : <span class="string">"app1的友盟 APP KEY"</span>,</div><div class="line">                                    UMENG_CHANNEL_VALUE: <span class="string">"app1默认的渠道名"</span>,</div><div class="line">                                    XG_ACCESS_ID       : <span class="string">"app1信鸽推送ACCESS_ID"</span>,</div><div class="line">                                    XG_ACCESS_KEY      : <span class="string">"app1信鸽推送ACCESS_KEY"</span>,</div><div class="line">                                    QQ_APP_ID          : <span class="string">"app1的QQ_APP_ID"</span>,</div><div class="line">                                    AMAP_KEY           : <span class="string">"app1的高德地图key"</span>,</div><div class="line">                                    APPLICATIONID      : applicationId]</div><div class="line">            <span class="comment">//签名文件</span></div><div class="line">            signingConfig signingConfigs.app1</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        app2 &#123;</div><div class="line">            dimension <span class="string">"APP"</span></div><div class="line">            applicationId <span class="string">'com.imliujun.app2'</span></div><div class="line"></div><div class="line">            versionName rootProject.ext.APP2_versionName</div><div class="line"></div><div class="line">            <span class="comment">//应用名</span></div><div class="line">            resValue <span class="string">"string"</span>, <span class="string">"app_name"</span>, <span class="string">"APP2"</span></div><div class="line"></div><div class="line">            buildConfigField <span class="string">"String"</span>, <span class="string">"versionNumber"</span>, <span class="string">"\"$&#123;rootProject.ext.APP2_versionName&#125;\""</span></div><div class="line"></div><div class="line">            <span class="comment">//第三方SDK的一些配置</span></div><div class="line">            buildConfigField <span class="string">"int"</span>, <span class="string">"IM_APPID"</span>, <span class="string">"app2的腾讯IM APPID"</span></div><div class="line">            buildConfigField <span class="string">"String"</span>, <span class="string">"IM_ACCOUNTTYPE"</span>, <span class="string">"\"app2的腾讯IM accountype\""</span></div><div class="line">            manifestPlaceholders = [UMENG_APP_KEY      : <span class="string">"app2的友盟 APP KEY"</span>,</div><div class="line">                                    UMENG_CHANNEL_VALUE: <span class="string">"app2默认的渠道名"</span>,</div><div class="line">                                    XG_ACCESS_ID       : <span class="string">"app2信鸽推送ACCESS_ID"</span>,</div><div class="line">                                    XG_ACCESS_KEY      : <span class="string">"app2信鸽推送ACCESS_KEY"</span>,</div><div class="line">                                    QQ_APP_ID          : <span class="string">"app2的QQ_APP_ID"</span>,</div><div class="line">                                    AMAP_KEY           : <span class="string">"app2的高德地图key"</span>,</div><div class="line">                                    APPLICATIONID      : applicationId]</div><div class="line">            <span class="comment">//签名文件</span></div><div class="line">            signingConfig signingConfigs.app2</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        offline &#123;</div><div class="line">            dimension <span class="string">"SERVER"</span></div><div class="line"></div><div class="line">            versionName getTestVersionName()</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        online &#123;</div><div class="line">            dimension <span class="string">"SERVER"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        admin &#123;</div><div class="line">            dimension <span class="string">"SERVER"</span></div><div class="line"></div><div class="line">            versionName rootProject.ext.versionName + <span class="string">"-管理员"</span></div><div class="line">            manifestPlaceholders.UMENG_CHANNEL_VALUE = <span class="string">"admin"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">android.applicationVariants.all &#123; variant -&gt;</div><div class="line">    <span class="keyword">switch</span> (variant.flavorName) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">"app1Admin"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://admin.app1domain.com/\""</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getTestVersionName() + <span class="string">"-管理员"</span>)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(rootProject.ext.APP1_VERSION_NAME + <span class="string">"-管理员"</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app1Offline"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://offline.app1domain.com/\""</span></div><div class="line">            variant.mergedFlavor.setVersionName(getTestVersionName())</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app1Online"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://online.app1domain.com/\""</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getTestVersionName())</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app2Admin"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://admin.app2domain.com/\""</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getApp2TestVersionName() + <span class="string">"-管理员"</span>)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(rootProject.ext.APP2_VERSION_NAME + <span class="string">"-管理员"</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app2Offline"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://offline.app2domain.com/\""</span></div><div class="line">            variant.mergedFlavor.setVersionName(getApp2TestVersionName())</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app2Online"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://online.app2domain.com/\""</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getApp2TestVersionName())</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">ext &#123;</div><div class="line">    APP1_VERSION_NAME = <span class="string">"2.0.2"</span></div><div class="line">    APP1_TEST_NUM = <span class="string">"0001"</span></div><div class="line">    APP2_VERSION_NAME = <span class="string">"1.0.5"</span></div><div class="line">    APP2_TEST_NUM = <span class="string">"0005"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> getTestVersionName() &#123;</div><div class="line">    <span class="keyword">return</span> String.format(<span class="string">"%s.%s"</span>, rootProject.ext.APP1_VERSION_NAME,</div><div class="line">            rootProject.ext.APP1_TEST_NUM)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> getApp2TestVersionName() &#123;</div><div class="line">    <span class="keyword">return</span> String.format(<span class="string">"%s.%s"</span>, rootProject.ext.APP2_VERSION_NAME,</div><div class="line">            rootProject.ext.APP2_TEST_NUM)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> gitVersionCode() &#123;</div><div class="line">    <span class="keyword">def</span> <span class="keyword">count</span> = <span class="string">"git rev-list HEAD --count"</span>.execute().text.trim()</div><div class="line">    <span class="keyword">return</span> <span class="keyword">count</span>.isInteger() ? <span class="keyword">count</span>.<span class="keyword">toInteger</span>() : <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上一篇文章的配置上进行了一些修改，同时保留上一篇文章里所有的功能。</p>
<h2 id="配置多应用"><a href="#配置多应用" class="headerlink" title="配置多应用"></a>配置多应用</h2><p>首先来看最重要的一个概念：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">flavorDimensions <span class="string">"APP"</span>, <span class="string">"SERVER"</span></div></pre></td></tr></table></figure>
<p>这一行代码配置了两个维度的 <code>flavor</code>，<code>APP</code> 代表多应用，<code>SERVER</code> 代表服务器版本。</p>
<p>根据上面的配置信息可以看到，<code>app1</code>、<code>app2</code> 设置了 <code>dimension &quot;APP&quot;</code> 所以属于 <code>APP</code> 这个维度，<code>offline</code>、<code>online</code>、<code>admin</code> 设置了 <code>dimension &quot;SERVER&quot;</code> 属于 <code>SERVER</code> 这个维度。</p>
<p>根据 Product Flavors 的两个维度 APP [app1, app2] 和 SERVER [offline, online, admin] 以及 Build Type [debug, release]，最后会生成以下 Build Variant：</p>
<ul>
<li><code>app1AdminDebug</code></li>
<li><code>app1AdminRelease</code></li>
<li><code>app1OfflineDebug</code></li>
<li><code>app1OfflineRelease</code></li>
<li><code>app1OnlineDebug</code></li>
<li><code>app1OnlineRelease</code></li>
<li><code>app2AdminDebug</code></li>
<li><code>app2AdminRelease</code></li>
<li><code>app2OfflineDebug</code></li>
<li><code>app2OfflineRelease</code></li>
<li><code>app2OnlineDebug</code></li>
<li><code>app2OnlineRelease</code></li>
</ul>
<p>是不是每个应用都有 3 个服务器版本，每个版本都有 <code>debug</code> 和 <code>release</code> 包。</p>
<h2 id="配置不同的包名"><a href="#配置不同的包名" class="headerlink" title="配置不同的包名"></a>配置不同的包名</h2><p>我们要实现多应用，必须能安装在同一台手机上。所以不同应用之间的包名得不一样。</p>
<p>在 <code>APP</code> 维度的 <code>flavor</code> 中设置不同的 <code>applicationId</code>，就可以实现修改应用包名。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app1&#123;</div><div class="line">    applicationId <span class="string">'com.imliujun.app1'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">app2&#123;</div><div class="line">    applicationId <span class="string">'com.imliujun.app2'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样配置后，<code>app1</code> 和 <code>app2</code> 就能够安装在同一台手机上，也能同时上传应用商店。</p>
<p>有一点大家切记，<code>AndroidManifest.xml</code> 中的 <code>package</code> 不需要去修改，R 文件的路径是根据这个 <code>package</code> 来生成的。如果对 <code>package</code> 进行修改，R 文件的路径也会改变，所有引用到 R 文件的类都需要进行修改。 </p>
<h2 id="动态配置-URL-和版本号"><a href="#动态配置-URL-和版本号" class="headerlink" title="动态配置 URL 和版本号"></a>动态配置 URL 和版本号</h2><p>既然每个 Build Variant 都是由不同维度的 Product Flavors 和 Build Type 组合而来，我们肯定不能像上一篇文章一样将服务器的 URL 配置在 <code>offline</code>、<code>online</code>、<code>admin</code> 中了，因为 <code>app1Offline</code> 和 <code>app2Offline</code> 同样是测试服，但不是同一个应用 URL 也不一样。</p>
<p>这个时候就需要通过 task 操作来根据不同的组合设置不同的数据了。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">android.applicationVariants.all &#123; variant -&gt;</div><div class="line">    <span class="comment">//判断当前的 flavorName 是什么版本</span></div><div class="line">    <span class="keyword">switch</span> (variant.flavorName) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">"app1Admin"</span>:</div><div class="line">            <span class="comment">//这是 app1 的超管版本，设置超管服务器 URL</span></div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://admin.app1domain.com/\""</span></div><div class="line">            <span class="comment">//判断当前是 `debug` 包还是 `release` 包，设置版本号</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getTestVersionName() + <span class="string">"-管理员"</span>)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(rootProject.ext.APP1_VERSION_NAME + <span class="string">"-管理员"</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app1Offline"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://offline.app1domain.com/\""</span></div><div class="line">            variant.mergedFlavor.setVersionName(getTestVersionName())</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app1Online"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://online.app1domain.com/\""</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getTestVersionName())</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app2Admin"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://admin.app2domain.com/\""</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getApp2TestVersionName() + <span class="string">"-管理员"</span>)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(rootProject.ext.APP2_VERSION_NAME + <span class="string">"-管理员"</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app2Offline"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://offline.app2domain.com/\""</span></div><div class="line">            variant.mergedFlavor.setVersionName(getApp2TestVersionName())</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"app2Online"</span>:</div><div class="line">            variant.buildConfigField <span class="string">"String"</span>, <span class="string">"DOMAIN_NAME"</span>,</div><div class="line">                    <span class="string">"\"https://online.app2domain.com/\""</span></div><div class="line">            <span class="keyword">if</span> (<span class="string">"debug"</span> == variant.buildType.getName()) &#123;</div><div class="line">                variant.mergedFlavor.setVersionName(getApp2TestVersionName())</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>两个 APP 的服务器 URL 和版本号不一致，所以通过 task 来动态设置。</p>
<h2 id="配置应用名"><a href="#配置应用名" class="headerlink" title="配置应用名"></a>配置应用名</h2><p>不同的应用配置自己的应用名：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">resValue <span class="string">"string"</span>, <span class="string">"app_name"</span>, <span class="string">"APP1"</span></div></pre></td></tr></table></figure>
<p>这行代码的意思和在 <code>strings.xml</code> 中定义一个 String 值是一样的。不过这里通过 Gradle 配置了 <code>app_name</code> 就不能在 <code>strings.xml</code> 中再定义了，会报错提示有冲突。</p>
<h2 id="配置应用签名"><a href="#配置应用签名" class="headerlink" title="配置应用签名"></a>配置应用签名</h2><p>如果多个应用使用同一个签名文件，按照上一篇文章写的在 <code>buildTypes</code> 的 <code>release</code> 和 <code>debug</code> 中配置就可以。但是每个应用的签名文件不一样呢？</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">signingConfigs &#123;</div><div class="line"></div><div class="line">    app1 &#123;</div><div class="line">        storeFile <span class="keyword">file</span>(<span class="string">"app1.jks"</span>)</div><div class="line">        storePassword <span class="string">"111111"</span></div><div class="line">        keyAlias <span class="string">"app1"</span></div><div class="line">        keyPassword <span class="string">"111111"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app2 &#123;</div><div class="line">        storeFile <span class="keyword">file</span>(<span class="string">"app2.jks"</span>)</div><div class="line">        storePassword <span class="string">"111111"</span></div><div class="line">        keyAlias <span class="string">"app2"</span></div><div class="line">        keyPassword <span class="string">"111111"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置多个签名文件，在 <code>APP</code> 这个维度的 <code>flavor</code> 中配置签名信息：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app1&#123;</div><div class="line">    signingConfig signingConfigs.app1</div><div class="line">&#125;</div><div class="line"></div><div class="line">app2&#123;</div><div class="line">    signingConfig signingConfigs.app2</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样就可以针对不同的应用设置不同的签名文件了。<strong>但是，还有一个要注意的地方，这个坑我以前没填上，而是绕远路绕过去了，现在我来填上它！</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">debug &#123;</div><div class="line">    signingConfig <span class="keyword">null</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一定要在 <code>debug</code> 中将签名文件的配置置空，不然 Build Type 的权限比 Product Flavors 要高，而 <code>debug</code> Build Type(构建类型) 会自动使用 <code>debug</code> SigningConfig (签名配置)，这样一来就将 <code>flavor</code> 中配置的签名信息给覆盖掉了。导致的问题就是编译 <code>release</code> 包没有问题，编译 <code>debug</code> 包就不能使用某些需要校验签名的第三方SDK了。</p>
<h2 id="配置不同应用的代码和资源"><a href="#配置不同应用的代码和资源" class="headerlink" title="配置不同应用的代码和资源"></a>配置不同应用的代码和资源</h2><p>终于来到重头戏了，现在只需要更换 UI、文案或者某些界面布局和逻辑代码就大功告成啦。</p>
<p>首先，建立每个应用对应的 <code>sourceSets</code> 目录，比如：</p>
<ul>
<li>app1 的 <code>sourceSets</code> 位置是 <code>src/app1/</code></li>
<li>app2 的 <code>sourceSets</code> 位置是 <code>src/app2/</code></li>
</ul>
<p><code>app1</code> 是已经开发完成的应用，只需要换 UI、文案就成了 <code>app2</code>，在 <code>src/app2/</code> 目录下再新建 <code>res</code> 目录，将需要替换的切图命名和 <code>app1</code> 中的命名保持一致放入 <code>res</code> 对应的目录下就完美换肤了。</p>
<p>文案同理，将需要替换的字符串在 <code>src/app2/res/values/strings.xml</code> 中再写一份，保持 <code>name</code> 相同，其中的内容随便替换。</p>
<p>布局文件、style、color 替换的规则同上。</p>
<p>微信登录、分享、支付的回调是返回到 <code>{应用包名.wxapi.WXEntryActivity}</code>、<code>{应用包名.wxapi.WXPayEntryActivity}</code> 这两个 Activity。</p>
<p>我们在 <code>app1</code> 和 <code>app2</code> 中都放入这两个回调 Activity：</p>
<p><img src="http://images.imliujun.com/static/images/Gradle/sourceSets1.png" alt="sourceSets 文件目录"></p>
<p>然后在 <code>AndroidManifest.xml</code> 文件中动态配置 Activity 的包名：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 微信分享回调 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">"$&#123;APPLICATIONID&#125;.wxapi.WXEntryActivity"</span>/&gt;</span></div><div class="line"><span class="comment">&lt;!-- 微信支付的回调 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">"$&#123;APPLICATIONID&#125;.wxapi.WXPayEntryActivity"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p><code>APPLICATIONID</code> 占位符在 Gradle 中设置：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manifestPlaceholders = [APPLICATIONID : applicationId]</div></pre></td></tr></table></figure>
<p>如果使用了 <code>ShareSDK</code> 做第三方分享和登录，需要配置 <code>ShareSDK.xml</code> 放到 <code>assets</code> 文件夹下，将 <code>main/assets/ShareSDK.xml</code> 复制一份到 <code>app2/assets/ShareSDK.xml</code>，将里面的第三方 APP ID 和 APP KEY 替换一下就可以了。</p>
<p>项目如果使用了 <code>ContentProvider</code> 要注意替换 <code>authorities</code>，如果 <code>authorities</code> 里面的值是一样的，手机上只能装一个应用哦，可以和上面动态配置 Activity 包名一样操作，用信鸽 SDK 演示一下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">&lt;!-- 【必须】 【注意】authorities修改为 包名.AUTH_XGPUSH, 如demo的包名为：com.qq.xgdemo --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">provider</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">"com.tencent.android.tpush.XGPushProvider"</span></div><div class="line">    <span class="attr">android:authorities</span>=<span class="string">"$&#123;APPLICATIONID&#125;.AUTH_XGPUSH"</span></div><div class="line">    <span class="attr">android:exported</span>=<span class="string">"true"</span>/&gt;</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>上面的内容基本涉及到所有的方面，其他的细节也好，特殊的需求定制也好，使用上面的方式去处理都能够解决。希望大家不要光学会复制粘贴，要掌握其原理，遇到类似的需求就能举一反三。</p>
<p>总结一下技术点：</p>
<ul>
<li><code>manifestPlaceholders</code> -&gt; <code>AndroidManifest.xml</code> 占位符</li>
<li><code>buildConfigField</code> -&gt; <code>BuildConfig</code> 动态配置常量值</li>
<li><code>resValue</code> -&gt; <code>String.xml</code> 动态配置字符串</li>
<li><code>signingConfigs</code> -&gt; 配置签名文件</li>
<li><code>productFlavors</code> -&gt; 产品定制多版本</li>
<li><code>flavorDimensions</code> -&gt; 为产品定制设置多个维度</li>
<li><code>android.applicationVariants</code> -&gt; 操作 task</li>
</ul>
<h1 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h1><ul>
<li><a href="http://www.imliujun.com/gradle1.html">使用 Gradle 对应用进行个性化定制</a></li>
<li><a href="http://www.imliujun.com/gradle2.html">Android Studio 3.0 上 Gradle 改动</a></li>
</ul>
<p><center>欢迎关注微信公众号：<strong>大脑好饿</strong>，更多干货等你来尝</center><br><img src="http://images.imliujun.com/static/images/wx_qrcode.png" alt="公众号：大脑好饿 "></p>
</div><iframe src="http://www.liujun.info/donate-page/simple/" style="overflow-x:hidden;overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;"  frameborder="0" scrolling="no"></iframe><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.imliujun.com/gradle3.html" data-id="cj4zfx99h0006h2fy2hz0p3e4" class="article-share-link">分享</a><div class="tags"><a href="/tags/Gradle/">Gradle</a></div><div class="post-nav"><a href="/gradle2.html" class="pre">Android Studio 3.0 上 Gradle 改动</a></div><div id="SOHUCS" sid="1499756783000"></div><script>(function(){var appid='cyt4LaybM';var conf='prod_ba6c39a7ee3948f6aafec787e567e6b7';var width=window.innerWidth||document.documentElement.clientWidth;if(width<960){window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id='+appid+'&conf='+conf+'"><\/script>')}else{var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})})}})()
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.imliujun.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/tags/Lottie/" style="font-size: 15px;">Lottie</a> <a href="/tags/直播/" style="font-size: 15px;">直播</a> <a href="/tags/动态加载/" style="font-size: 15px;">动态加载</a> <a href="/tags/礼物/" style="font-size: 15px;">礼物</a> <a href="/tags/动画/" style="font-size: 15px;">动画</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/gradle3.html">使用 Gradle 实现一套代码开发多个应用</a></li><li class="post-list-item"><a class="post-list-link" href="/gradle2.html">Android Studio 3.0 上 Gradle 改动</a></li><li class="post-list-item"><a class="post-list-link" href="/gradle1.html">使用 Gradle 对应用进行个性化定制</a></li><li class="post-list-item"><a class="post-list-link" href="/Lottie库实现直播礼物动画.html">Lottie -- 轻松实现动态加载直播礼物动画</a></li><li class="post-list-item"><a class="post-list-link" href="/hello-world.html">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://jinweime.com/" title="JinWei" target="_blank">JinWei</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">大脑好饿.</a><a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/"> 京ICP备14053652号-1</a><div></div> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?88a3cbe2051fe51ad73ae8e48687dcbd";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>